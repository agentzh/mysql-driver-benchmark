#!/bin/bash

uri=http://127.0.0.1:8080/t
curl -s -i $uri

if [ ! -d logs/ ]; then
    mkdir -p logs || exit 1
fi

pids=

function cleanup {
    if [ -n "$pids" ]; then
        kill $pids
        sleep 0.3
        kill -9 $pids
        exit
    fi
}

trap cleanup SIGHUP SIGINT SIGTERM

#./watch-mysql &
#pids="$pids $!"

#./watch-nginx &
#pids="$pids $!"

#./watch-weighttp &
#pids="$pids $!"

c=20
total=0
while [ $c -le 1000 ]; do
    n=$((c * 5))
    total=$((total + n))

    if [ $total -ge 40000 ]; then
        sleep 10
        total=0
    else
        sleep 0.5
    fi

    echo ===
    echo BEGIN `date +"%Y-%m-%d %H:%M:%S"`
    weighttp -k -c$c -n$n $uri
    echo END `date +"%Y-%m-%d %H:%M:%S"`
    c=$((c + 20))
done

if [ -n "$pids" ]; then

    echo killing $pids
    kill $pids

    sleep 0.3

    echo killing $pids with force
    kill -9 $pids > /dev/null 2>&1

    ps aux|grep watch|grep -v grep
fi

